<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>盲人導讀師 (LINE 連動版)</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
body { background-color: #121212; color: #ffffff; font-family: 'Inter', sans-serif, 'Microsoft JhengHei', '微軟正黑體'; }
.btn { transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; }
.btn:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
.btn:active { transform: translateY(0); box-shadow: none; }
textarea:focus { box-shadow: 0 0 0 3px rgba(59,130,246,0.5); border-color: #3B82F6; }
.status-dot { height: 12px; width: 12px; border-radius: 50%; display: inline-block; margin-right: 6px; }
.status-connected { background-color: #22c55e; }
.status-disconnected { background-color: #ef4444; animation: pulse 2s infinite; }
@keyframes pulse {
    0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(239,68,68,0.7); }
    70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(239,68,68,0); }
    100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(239,68,68,0); }
}
</style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">
<main class="w-full max-w-2xl mx-auto p-6 md:p-8 bg-[#1e1e1e] rounded-2xl shadow-lg">
<header class="text-center mb-6">
<h1 class="text-3xl md:text-4xl font-bold text-white">盲人導讀師</h1>
<div class="flex items-center justify-center mt-2 text-lg">
    <span id="status-dot" class="status-dot status-disconnected"></span>
    <span id="status-text" class="text-gray-300">請點擊下方啟用語音</span>
</div>
<div class="mt-1 text-gray-400 text-sm" id="last-time">最後訊息時間：-</div>
</header>

<div class="mb-6">
<textarea id="text-to-read" rows="8" class="w-full p-4 bg-[#2d2d2d] text-white text-lg rounded-lg border-2 border-gray-600 resize-none" placeholder="等待接收來自 LINE 的訊息..." readonly></textarea>
</div>

<div class="grid grid-cols-1 sm:grid-cols-2 gap-4 justify-items-center">
<button id="enable-speech" class="btn w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg text-lg">啟用語音</button>
<button id="stop-btn" class="btn w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-lg text-lg">停止朗讀</button>
</div>
</main>

<script>
let speechEnabled = false;
let lastId = null;
let voices = [];
let zhVoice = null;

const statusDot = document.getElementById('status-dot');
const statusText = document.getElementById('status-text');
const lastTime = document.getElementById('last-time');
const textArea = document.getElementById('text-to-read');

// 等待 voices 載入
function loadVoices() {
    voices = window.speechSynthesis.getVoices();
    zhVoice = voices.find(v => v.lang === 'zh-TW' && v.name.includes('Google'));
    if (!zhVoice && voices.length) zhVoice = voices[0]; // fallback
    console.log('可用語音：', voices.map(v => v.name));
}

window.speechSynthesis.onvoiceschanged = () => {
    loadVoices();
};

loadVoices();

function speak(text) {
    if(!speechEnabled || !text) return;
    window.speechSynthesis.cancel();
    const utter = new SpeechSynthesisUtterance(text);
    utter.lang = 'zh-TW';
    if(zhVoice) utter.voice = zhVoice;
    utter.rate = 1;
    utter.pitch = 1;
    window.speechSynthesis.speak(utter);
}

// 啟用語音
document.getElementById('enable-speech').addEventListener('click', () => {
    if(!zhVoice) {
        alert('語音尚未準備好，請稍候再點擊');
        return;
    }

    speechEnabled = true;
    document.getElementById('enable-speech').style.display = 'none';
    statusText.textContent = '已啟用語音，將自動朗讀新訊息';

    // 播放一次空 Utterance 解鎖 TTS
    const u = new SpeechSynthesisUtterance('正在啟用語音');
    u.lang = 'zh-TW';
    if(zhVoice) u.voice = zhVoice;
    window.speechSynthesis.speak(u);
});

// 停止朗讀
document.getElementById('stop-btn').addEventListener('click', () => {
    window.speechSynthesis.cancel();
});

// 輪詢最新 LINE 訊息
setInterval(async () => {
    if(!speechEnabled) return;
    try {
        const res = await fetch('https://script.google.com/macros/s/AKfycbxeMfXVE-EX-EYclDvIygXy55SGiQxxws4g6zbgLosUD5b9lcB2UUeNIMIwEniY8cQifQ/exec');
        const data = await res.json();
        if(data.error) {
            console.error(data.error);
            statusDot.classList.remove('status-connected');
            statusDot.classList.add('status-disconnected');
            statusText.textContent = '無法取得 LINE 訊息';
            return;
        }

        statusDot.classList.remove('status-disconnected');
        statusDot.classList.add('status-connected');
        statusText.textContent = '已連線至 LINE Bot 服務';

        if(data.timestamp !== lastId){
            lastId = data.timestamp;
            textArea.value = data.text;
            speak(data.text);

            const t = new Date(data.timestamp);
            lastTime.textContent = '最後訊息時間：' + t.toLocaleString();
        }

    } catch(e){
        console.error('讀取訊息失敗:', e);
        statusDot.classList.remove('status-connected');
        statusDot.classList.add('status-disconnected');
        statusText.textContent = '服務連線失敗';
    }
}, 3000);
</script>
</body>
</html>
