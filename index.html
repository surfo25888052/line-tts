<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>盲人導讀師 (LINE 連動版)</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
body { background-color: #121212; color: #fff; font-family:'Inter','微軟正黑體'; }
.btn { display:flex; justify-content:center; align-items:center; transition:0.3s; }
.btn:hover { transform: translateY(-2px); box-shadow:0 4px 8px rgba(0,0,0,0.2);}
textarea:focus{box-shadow:0 0 0 3px rgba(59,130,246,0.5); border-color:#3B82F6;}
.status-dot{width:12px; height:12px; border-radius:50%; display:inline-block; margin-right:6px;}
.status-connected{background-color:#22c55e;}
.status-disconnected{background-color:#ef4444; animation:pulse 2s infinite;}
@keyframes pulse{
0%{transform:scale(0.95); box-shadow:0 0 0 0 rgba(239,68,68,0.7);}
70%{transform:scale(1); box-shadow:0 0 0 10px rgba(239,68,68,0);}
100%{transform:scale(0.95); box-shadow:0 0 0 0 rgba(239,68,68,0);}
}
</style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">
<main class="w-full max-w-2xl p-6 bg-[#1e1e1e] rounded-2xl shadow-lg">
<header class="text-center mb-6">
<h1 class="text-3xl md:text-4xl font-bold">盲人導讀師</h1>
<div class="flex items-center justify-center mt-2 text-lg">
    <span id="status-dot" class="status-dot status-disconnected"></span>
    <span id="status-text" class="text-gray-300">請點擊啟用語音</span>
</div>
<div class="mt-1 text-gray-400 text-sm" id="last-time">最後訊息時間：-</div>
</header>

<div class="mb-6">
<textarea id="text-to-read" rows="8" class="w-full p-4 bg-[#2d2d2d] text-white text-lg rounded-lg border-2 border-gray-600 resize-none" placeholder="等待接收來自 LINE 的訊息..." readonly></textarea>
</div>

<!-- ✅ 語音選擇 -->
<div class="mb-6">
  <label for="voice" class="text-gray-300 block mb-2">語音選擇：</label>
  <select id="voice" class="w-full p-2 bg-[#2d2d2d] border border-gray-600 rounded-lg text-white"></select>
</div>

<!-- ✅ 語速控制 -->
<div class="mb-6 flex items-center gap-4">
  <label for="rate" class="text-gray-300">語速：</label>
  <input type="range" id="rate" min="0.5" max="2" step="0.1" value="0.8" class="w-full">
  <span id="rate-value" class="text-gray-300">0.8x</span>
</div>

<div id="buttons" class="flex justify-center gap-4">
<button id="enable-speech" class="btn w-40 bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg text-lg">啟用語音</button>
<button id="reread-btn" class="btn w-40 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg text-lg">重讀一次</button>
<button id="stop-btn" class="btn w-40 bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-lg text-lg">停止朗讀</button>
</div>
</main>

<script>
let speechEnabled = false;
let lastMessage = null;
let speechRate = 0.8; // ✅ 預設語速
let voices = [];
let selectedVoice = null;

const statusDot = document.getElementById('status-dot');
const statusText = document.getElementById('status-text');
const lastTime = document.getElementById('last-time');
const textArea = document.getElementById('text-to-read');
const enableBtn = document.getElementById('enable-speech');
const rateSlider = document.getElementById('rate');
const rateValue = document.getElementById('rate-value');
const voiceSelect = document.getElementById('voice');

// ✅ 語速控制
rateSlider.addEventListener('input', ()=>{
  speechRate = parseFloat(rateSlider.value);
  rateValue.textContent = speechRate.toFixed(1) + "x";
});

// ✅ 載入可用的語音
function loadVoices() {
  voices = speechSynthesis.getVoices();
  voiceSelect.innerHTML = "";
  voices.forEach((v, i) => {
    const option = document.createElement("option");
    option.value = i;
    option.textContent = `${v.name} (${v.lang})`;
    if(v.lang === "zh-TW") option.selected = true; // 預設挑 zh-TW
    voiceSelect.appendChild(option);
  });
  selectedVoice = voices.find(v => v.lang === "zh-TW") || voices[0];
}
speechSynthesis.onvoiceschanged = loadVoices;

// ✅ 語音選擇
voiceSelect.addEventListener("change", () => {
  selectedVoice = voices[voiceSelect.value];
});

const speak = (text) => {
    if(!speechEnabled || !text) return;
    window.speechSynthesis.cancel();
    const u = new SpeechSynthesisUtterance(text);
    u.lang = selectedVoice?.lang || "zh-TW";
    u.voice = selectedVoice || null;
    u.rate = speechRate; // ✅ 使用動態語速
    window.speechSynthesis.speak(u);
};

// 點擊啟用語音，按鈕消失
enableBtn.addEventListener('click', ()=>{
    const u = new SpeechSynthesisUtterance('');
    u.lang = 'zh-TW';
    window.speechSynthesis.speak(u);
    speechEnabled = true;
    enableBtn.style.display = 'none';
    statusText.textContent = '已啟用語音，自動朗讀新訊息';
});

// 重讀 / 停止
document.getElementById('reread-btn').addEventListener('click', () => { speak(textArea.value); });
document.getElementById('stop-btn').addEventListener('click', () => { window.speechSynthesis.cancel(); });

// 輪詢最新 LINE 訊息
const SHEET_URL = 'https://script.google.com/macros/s/AKfycbxeMfXVE-EX-EYclDvIygXy55SGiQxxws4g6zbgLosUD5b9lcB2UUeNIMIwEniY8cQifQ/exec';
setInterval(async ()=>{
    try{
        const res = await fetch(SHEET_URL);
        const data = await res.json();
        if(data.error){
            statusDot.className="status-dot status-disconnected";
            statusText.textContent="無法取得訊息";
            return;
        }
        statusDot.className="status-dot status-connected";
        statusText.textContent="已連線至 LINE Bot 服務";

        if(data.text !== lastMessage){
            lastMessage = data.text;
            textArea.value = data.text;
            speak(data.text);
            if(data.timestamp){
                const t = new Date(data.timestamp);
                lastTime.textContent = '最後訊息時間：'+t.toLocaleString();
            }
        }
    }catch(e){
        console.error(e);
        statusDot.className="status-dot status-disconnected";
        statusText.textContent="服務連線失敗";
    }
},3000);
</script>
</body>
</html>
