<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>盲人導讀師 (LINE 連動版)</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
body { background-color: #121212; color: #fff; font-family:'Inter','微軟正黑體'; }
.btn { display:flex; justify-content:center; align-items:center; transition:0.3s; }
.btn:hover { transform: translateY(-2px); box-shadow:0 4px 8px rgba(0,0,0,0.2);}
textarea:focus{box-shadow:0 0 0 3px rgba(59,130,246,0.5); border-color:#3B82F6;}
.status-dot{width:12px; height:12px; border-radius:50%; display:inline-block; margin-right:6px;}
.status-connected{background-color:#22c55e;}
.status-disconnected{background-color:#ef4444; animation:pulse 2s infinite;}
@keyframes pulse{
0%{transform:scale(0.95); box-shadow:0 0 0 0 rgba(239,68,68,0.7);}
70%{transform:scale(1); box-shadow:0 0 0 10px rgba(239,68,68,0);}
100%{transform:scale(0.95); box-shadow:0 0 0 0 rgba(239,68,68,0);}
}
</style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">
<main class="w-full max-w-2xl p-6 bg-[#1e1e1e] rounded-2xl shadow-lg">
<header class="text-center mb-6">
<h1 class="text-3xl md:text-4xl font-bold">盲人導讀師</h1>
<div class="flex items-center justify-center mt-2 text-lg">
    <span id="status-dot" class="status-dot status-disconnected"></span>
    <span id="status-text" class="text-gray-300">請點擊啟用語音</span>
</div>
<div class="mt-1 text-gray-400 text-sm" id="last-time">最後訊息時間：-</div>
</header>

<div class="mb-6">
<textarea id="text-to-read" rows="8" class="w-full p-4 bg-[#2d2d2d] text-white text-lg rounded-lg border-2 border-gray-600 resize-none" placeholder="等待接收來自 LINE 的訊息..." readonly></textarea>
</div>

<div id="buttons" class="flex justify-center gap-4">
<button id="enable-speech" class="btn w-40 bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg text-lg">啟用語音</button>
<button id="reread-btn" class="btn w-40 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg text-lg">重讀一次</button>
<button id="stop-btn" class="btn w-40 bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-lg text-lg">停止朗讀</button>
</div>
</main>

<script>
let speechEnabled = false;
let lastMessage = null;

const statusDot = document.getElementById('status-dot');
const statusText = document.getElementById('status-text');
const lastTime = document.getElementById('last-time');
const textArea = document.getElementById('text-to-read');
const enableBtn = document.getElementById('enable-speech');

const speak = (text) => {
    if(!speechEnabled || !text) return;
    window.speechSynthesis.cancel();
    const u = new SpeechSynthesisUtterance(text);
    u.lang = 'zh-TW';
    window.speechSynthesis.speak(u);
};

// 點擊啟用語音，按鈕消失
enableBtn.addEventListener('click', ()=>{
    const u = new SpeechSynthesisUtterance('');
    u.lang = 'zh-TW';
    window.speechSynthesis.speak(u);
    speechEnabled = true;
    enableBtn.style.display = 'none';
    statusText.textContent = '已啟用語音，自動朗讀新訊息';
});

// 重讀 / 停止
document.getElementById('reread-btn').addEventListener('click', () => { speak(textArea.value); });
document.getElementById('stop-btn').addEventListener('click', () => { window.speechSynthesis.cancel(); });

// 輪詢最新 LINE 訊息
const SHEET_URL = 'https://script.google.com/macros/s/AKfycbxeMfXVE-EX-EYclDvIygXy55SGiQxxws4g6zbgLosUD5b9lcB2UUeNIMIwEniY8cQifQ/exec';
setInterval(async ()=>{
    try{
        const res = await fetch(SHEET_URL);
        const data = await res.json();
        if(data.error){
            statusDot.className="status-dot status-disconnected";
            statusText.textContent="無法取得訊息";
            return;
        }
        statusDot.className="status-dot status-connected";
        statusText.textContent="已連線至 LINE Bot 服務";

        if(data.text !== lastMessage){
            lastMessage = data.text;
            textArea.value = data.text;
            speak(data.text);
            if(data.timestamp){
                const t = new Date(data.timestamp);
                lastTime.textContent = '最後訊息時間：'+t.toLocaleString();
            }
        }
    }catch(e){
        console.error(e);
        statusDot.className="status-dot status-disconnected";
        statusText.textContent="服務連線失敗";
    }
},3000);
</script>
</body>
</html>
